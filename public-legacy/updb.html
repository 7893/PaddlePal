<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<meta charset="utf-8">
	<!-- metro templets CSS -->
	<link rel="stylesheet" type="text/css" href="templets/metro/css/bootstrap.min.css" />
	<link rel="stylesheet" type="text/css" href="templets/metro/css/main.css" />
	<script type="text/javascript" src="js/jquery-3.2.1.min.js"></script>
	<script type="text/javascript" src="js/spark-md5.js"></script>
	<script type="text/javascript">
	var is_run = false;
	var tm_handler;
	var md5_checksum = "";

	function key_down(e) {
		// 只允许数字键
		var k = window.event ? e.keyCode : e.which;
		if (k != 8 && k != 0 && (k < 48 || k > 57)) {
			if (window.event) {
				window.event.returnValue = false;
			} else {
				e.preventDefault(); //for firefox
			}
		}
	}

	function key_up(e) {
		// 根据数值更新按钮描述
		var v = $("#sec").val();
		if (v.length == 0 || parseInt(v) == 0) {
			$("#btn").val("上传");
		} else {
			$("#btn").val("开始");
		}
	}

	function cur_log() {
		// 格式化时间
		var date = new Date();
		var hour = '' + date.getHours();
		var mins = '' + date.getMinutes();
		var secs = '' + date.getSeconds();
		if (hour.length < 2)
			hour = '0' + hour;
		if (mins.length < 2)
			mins = '0' + mins;
		if (secs.length < 2)
			secs = '0' + secs;
		var log = $("#log").prop("outerHTML") + [hour, mins, secs].join(':') + " ";
		return log;
	}

	function upload_db() {
		var log = cur_log();
		var db = $("#data_db").val();

		// 检查是否选择文件
		if (db == "" || db.indexOf("data.db") < 0) {
			$("#log").html(log + " data.db 文件未选择或选择有误.<br>");
			return;
		}
		// 生成表单提交
		var fd = new FormData();
		fd.append("upload", 1);
		fd.append("data_db", $("#data_db").get(0).files[0]);
		log += " 数据上传 ...";
		$("#log").html(log);
		// ajax POST提交
		$.ajax({
			url: "/",
			type: "POST",
			processData: false,
			contentType: false,
			data: fd,
			success: function(d) {
				log += " 成功.<br>";
				$("#log").html(log);
			},
			error: function(d) {
				log += " 失败.<br>";
				$("#log").html(log);
			}
		});
	}

	function upload_md5(isManual) {
		var db = $("#data_db").val();
		// 检查是否选择文件
		if (db == "" || db.indexOf("data.db") < 0) {
			$("#log").html(cur_log() + " data.db 文件未选择或选择有误.<br>");
			return;
		}
		var fileReader = new FileReader(),
			blobSlice = File.prototype.mozSlice || File.prototype.webkitSlice || File.prototype.slice,
			file = $("#data_db").get(0).files[0],
			chunkSize = 2097152,
			chunks = Math.ceil(file.size / chunkSize),
			currentChunk = 0,
			spark = new SparkMD5();
			fileReader.onload = function(e) {
				spark.appendBinary(e.target.result);
				currentChunk++;
				if (currentChunk < chunks) {
					loadNext();
				} else {
					var md5_sum = "" + spark.end();
					if (isManual) {
						md5_checksum = md5_sum;
						upload_db();
					} else {
						if (md5_checksum != md5_sum) {
							md5_checksum = md5_sum;
							upload_db();
						} else {
							$("#log").html(cur_log() + " 数据未改动不上传.<br>");
						}
					}
				}
			};
			function loadNext() {
				var start = currentChunk * chunkSize,
					end = start + chunkSize >= file.size ? file.size : start + chunkSize;
				fileReader.readAsBinaryString(blobSlice.call(file, start, end));
			};
		loadNext();
	}

    function btn_click() {
        var log = cur_log();
        if (is_run) {
            // 停止
            clearInterval(tm_handler);
            key_up();
            $("#sec").removeAttr("disabled"); // enable input text
            $("#log").html(log + " 自动上传停止成功.<br>");
            is_run = false;
        } else {
            // 获取间隔时间
            var secs = parseInt($("#sec").val()) * 1000; // mseconds
            if (secs > 0) {
                if (secs < 20000) {
                    $("#log").html(log + " 自动上传时间间隔不能小于20秒.<br>");
                    return;
                }
                // 启动上传
                tm_handler = setInterval("upload_md5(false)", secs);
                is_run = true;
                $("#sec").attr("disabled", "true"); // disable
                $("#btn").val("停止");
                $("#log").html(log + " 启动自动上传成功.<br>");
            } else {
                // 手工上传
                upload_md5(true);
            }
        }
    }

    function clr_click() {
        $("#log").html("");
    }
    </script>
</head>

<body>
    <div class="container">
        <div class="content-wrap">
            <div class="content">
                <nav class="navbar navbar-default">
                    <div class="container-fluid">
                        <div class="navbar-header">
                            <span class="navbar-brand">上传数据</span>
                        </div>
                    </div>
                </nav>
                <div class="container">
                    <div class="row">
                        <div class="col-lg-4"></div>
                        <div class="col-lg-4">
                            <div class="alert alert-danger" role="alert">
                                <strong>注意：上传数据将覆盖服务器端数据，请慎重操作！</strong></div>
                        </div>
                        <div class="col-lg-4"></div>
                    </div>
                </div>
                <div class="container">
                    <div class="row">
                        <div class="col-lg-4"></div>
                        <div class="col-lg-4">
                            <div class="panel panel-default">
                                <div class="panel-heading">
                                    <h3 class="panel-title">
											选择数据文件
											</h3>
                                </div>
                                <div class="panel-body">
                                    <input type="file" id="data_db">
                                    <br />
                                    <div class="input-group">
                                        <span class="input-group-addon" id="sizing-addon1">请输入自动上传间隔时间（秒）：</span>
                                        <input type="text" id="sec" class="form-control" aria-label="time" value="0" size="3" maxlength="3" onkeydown="key_down(event)" onkeyup="key_up(event)" />
                                        <div class="input-group-btn">
                                            <input type="button" id="btn" class="btn btn-primary" value="上传" onClick="btn_click()" />
                                            <!-- Buttons -->
                                        </div>
                                        <div class="input-group-btn">
                                            <input type="button" id="clr" class="btn btn-default" value="清除日志" onClick="clr_click()" />
                                            <!-- Buttons -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="panel panel-success">
                                <div class="panel-heading">
                                    <h3 class="panel-title">
											上传操作记录
											</h3>
                                </div>
                                <div class="panel-body">
                                    <div id="log"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4"></div>
                    </div>
                </div>
            </div>
            <!-- /content-wrap -->
        </div>
        <!-- /container -->
</body>

</html>
