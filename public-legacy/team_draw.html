<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>团体赛编排 - 赛事助手</title>
    <link rel="stylesheet" href="templets/metro/css/bootstrap.min.css">
    <style>
        .admin-nav { background: #337ab7; padding: 10px 20px; margin-bottom: 20px; }
        .admin-nav a { color: white; margin-right: 20px; }
        .team-box { border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .match-row { padding: 10px; margin: 5px 0; background: #f9f9f9; border-radius: 3px; }
    </style>
</head>
<body>
<div class="admin-nav">
    <a href="admin.html">管理后台</a>
    <a href="events.html">项目管理</a>
    <a href="draw.html">个人抽签</a>
    <a href="team_draw.html"><b>团体编排</b></a>
</div>

<div class="container">
    <h3>团体赛编排</h3>
    
    <div class="row">
        <div class="col-md-4">
            <div class="panel panel-primary">
                <div class="panel-heading">选择团体项目</div>
                <div class="panel-body">
                    <select class="form-control" id="eventSelect" onchange="loadTeamDraw()">
                        <option value="">-- 选择项目 --</option>
                    </select>
                </div>
            </div>
            
            <div class="panel panel-info">
                <div class="panel-heading">参赛队伍</div>
                <div class="panel-body" id="teamList"></div>
            </div>
        </div>
        
        <div class="col-md-8">
            <div class="panel panel-success">
                <div class="panel-heading">
                    团体对阵
                    <button class="btn btn-warning btn-xs pull-right" onclick="generateTeamMatches()">生成对阵</button>
                </div>
                <div class="panel-body" id="matchList"></div>
            </div>
        </div>
    </div>
</div>

<script src="js/jquery-3.2.1.min.js"></script>
<script>
function loadEvents() {
    $.get('/api/admin/events', function(data) {
        var opts = '<option value="">-- 选择团体项目 --</option>';
        (data.events || []).forEach(function(e) {
            if (e.type.endsWith('T')) {
                opts += '<option value="' + e.id + '">' + e.title + '</option>';
            }
        });
        $('#eventSelect').html(opts);
    });
}

function loadTeamDraw() {
    var eventId = $('#eventSelect').val();
    if (!eventId) return;
    
    $.get('/api/admin/team_draw?event=' + eventId, function(data) {
        // 队伍列表
        var tHtml = '';
        (data.teams || []).forEach(function(t) {
            tHtml += '<div class="team-box"><b>' + t.name + '</b> (' + t.count + '人)</div>';
        });
        $('#teamList').html(tHtml || '<p class="text-muted">暂无队伍</p>');
        
        // 对阵列表
        var mHtml = '';
        (data.matches || []).forEach(function(m) {
            mHtml += '<div class="match-row">' +
                '<span class="badge">' + m.order + '</span> ' +
                '<b>' + m.team1 + '</b> vs <b>' + m.team2 + '</b> ' +
                '<span class="label label-' + (m.status=='finished'?'success':'default') + '">' + (m.result || '待比赛') + '</span>' +
                ' <button class="btn btn-xs btn-primary" onclick="editTeamMatch(' + m.id + ')">详情</button>' +
                '</div>';
        });
        $('#matchList').html(mHtml || '<p class="text-muted">暂无对阵，请点击"生成对阵"</p>');
    });
}

function generateTeamMatches() {
    var eventId = $('#eventSelect').val();
    if (!eventId) return;
    if (!confirm('生成团体对阵将覆盖现有数据，确定？')) return;
    
    $.post('/api/admin/team_draw/generate', JSON.stringify({event_id: parseInt(eventId)}), function(res) {
        if (res.success) { alert('已生成 ' + res.count + ' 场团体赛'); loadTeamDraw(); }
        else alert('生成失败: ' + res.error);
    }, 'json');
}

function editTeamMatch(id) {
    location.href = 'team_match.html?id=' + id;
}

loadEvents();
</script>
</body>
</html>
