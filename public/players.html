<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>选手管理 - 赛事助手</title>
    <link rel="stylesheet" href="templets/metro/css/bootstrap.min.css">
    <style>
        .admin-nav { background: #337ab7; padding: 10px 20px; margin-bottom: 20px; }
        .admin-nav a { color: white; margin-right: 20px; }
    </style>
</head>
<body>
<div class="admin-nav">
    <a href="admin.html">管理后台</a>
    <a href="control.html">控场面板</a>
    <a href="players.html"><b>选手管理</b></a>
    <a href="teams.html">队伍管理</a>
    <a href="index.html">返回前台</a>
</div>

<div class="container">
    <h3>选手管理 <button class="btn btn-primary btn-sm" onclick="showAdd()">+ 添加选手</button>
        <button class="btn btn-success btn-sm" onclick="$('#importModal').modal('show')">导入Excel</button></h3>
    
    <table class="table table-striped table-hover" id="playerTable">
        <thead><tr><th>ID</th><th>姓名</th><th>性别</th><th>队伍</th><th>操作</th></tr></thead>
        <tbody></tbody>
    </table>
</div>

<!-- 编辑弹窗 -->
<div class="modal fade" id="editModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title" id="modalTitle">添加选手</h4>
            </div>
            <div class="modal-body">
                <input type="hidden" id="playerId">
                <div class="form-group">
                    <label>姓名</label>
                    <input type="text" class="form-control" id="playerName" required>
                </div>
                <div class="form-group">
                    <label>性别</label>
                    <select class="form-control" id="playerGender">
                        <option value="M">男</option>
                        <option value="F">女</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>队伍</label>
                    <select class="form-control" id="playerTeam"></select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="savePlayer()">保存</button>
            </div>
        </div>
    </div>
</div>

<!-- 导入弹窗 -->
<div class="modal fade" id="importModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">导入选手</h4>
            </div>
            <div class="modal-body">
                <p>Excel/CSV 格式：每行一个选手，格式为 <code>姓名,性别,队伍</code></p>
                <p>示例：<br><code>张三,M,红队<br>李四,F,蓝队</code></p>
                <textarea class="form-control" id="importData" rows="10" placeholder="粘贴数据..."></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="importPlayers()">导入</button>
            </div>
        </div>
    </div>
</div>

<script src="js/jquery-3.2.1.min.js"></script>
<script src="templets/metro/js/bootstrap.min.js"></script>
<script>
var teams = [];

function loadTeams() {
    $.get('/api/admin/teams', function(data) {
        teams = data.teams || [];
        var opts = '<option value="">无</option>';
        teams.forEach(function(t) { opts += '<option value="' + t.id + '">' + t.name + '</option>'; });
        $('#playerTeam').html(opts);
    });
}

function loadPlayers() {
    $.get('/api/admin/players', function(data) {
        var html = '';
        (data.players || []).forEach(function(p) {
            html += '<tr><td>' + p.id + '</td><td>' + p.name + '</td>' +
                '<td>' + (p.gender == 'M' ? '男' : '女') + '</td>' +
                '<td>' + (p.team || '-') + '</td>' +
                '<td><button class="btn btn-xs btn-info" onclick="editPlayer(' + p.id + ')">编辑</button> ' +
                '<button class="btn btn-xs btn-danger" onclick="deletePlayer(' + p.id + ')">删除</button></td></tr>';
        });
        $('#playerTable tbody').html(html || '<tr><td colspan="5" class="text-center">暂无选手</td></tr>');
    });
}

function showAdd() {
    $('#modalTitle').text('添加选手');
    $('#playerId').val('');
    $('#playerName').val('');
    $('#playerGender').val('M');
    $('#playerTeam').val('');
    $('#editModal').modal('show');
}

function editPlayer(id) {
    $.get('/api/admin/players?id=' + id, function(data) {
        if (data.player) {
            $('#modalTitle').text('编辑选手');
            $('#playerId').val(data.player.id);
            $('#playerName').val(data.player.name);
            $('#playerGender').val(data.player.gender);
            $('#playerTeam').val(data.player.team_id || '');
            $('#editModal').modal('show');
        }
    });
}

function savePlayer() {
    var data = {
        id: parseInt($('#playerId').val()) || 0,
        name: $('#playerName').val(),
        gender: $('#playerGender').val(),
        team_id: parseInt($('#playerTeam').val()) || 0
    };
    $.ajax({
        url: '/api/admin/players',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(data),
        success: function(res) {
            if (res.success) {
                $('#editModal').modal('hide');
                loadPlayers();
            } else {
                alert('保存失败: ' + res.error);
            }
        }
    });
}

function deletePlayer(id) {
    if (confirm('确定删除该选手？')) {
        $.ajax({
            url: '/api/admin/players?id=' + id,
            method: 'DELETE',
            success: function(res) {
                if (res.success) loadPlayers();
                else alert('删除失败: ' + res.error);
            }
        });
    }
}

loadTeams();
loadPlayers();

function importPlayers() {
    var data = $('#importData').val().trim();
    if (!data) { alert('请输入数据'); return; }
    $.ajax({
        url: '/api/admin/players/import',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({data: data}),
        success: function(res) {
            if (res.success) {
                alert('成功导入 ' + res.count + ' 名选手');
                $('#importModal').modal('hide');
                $('#importData').val('');
                loadPlayers();
            } else {
                alert('导入失败: ' + res.error);
            }
        }
    });
}
</script>
</body>
</html>
