<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>抽签编排 - 赛事助手</title>
    <link rel="stylesheet" href="templets/metro/css/bootstrap.min.css">
    <style>
        .admin-nav { background: #337ab7; padding: 10px 20px; margin-bottom: 20px; }
        .admin-nav a { color: white; margin-right: 20px; }
        .group-box { border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .group-title { font-weight: bold; color: #337ab7; margin-bottom: 10px; }
        .player-item { padding: 5px 10px; margin: 3px 0; background: #f5f5f5; border-radius: 3px; }
        .player-item:hover { background: #e0e0e0; }
    </style>
</head>
<body>
<div class="admin-nav">
    <a href="admin.html">管理后台</a>
    <a href="tournament.html">赛事管理</a>
    <a href="events.html">项目管理</a>
    <a href="draw.html"><b>抽签编排</b></a>
    <a href="index.html">返回前台</a>
</div>

<div class="container">
    <h3>抽签编排</h3>
    
    <div class="row">
        <div class="col-md-4">
            <div class="panel panel-primary">
                <div class="panel-heading">选择项目</div>
                <div class="panel-body">
                    <select class="form-control" id="eventSelect" onchange="loadDraw()">
                        <option value="">-- 选择项目 --</option>
                    </select>
                </div>
            </div>
            
            <div class="panel panel-info">
                <div class="panel-heading">待分配选手 <span class="badge" id="unassignedCount">0</span></div>
                <div class="panel-body" id="unassignedList" style="max-height: 400px; overflow-y: auto;"></div>
            </div>
        </div>
        
        <div class="col-md-8">
            <div class="panel panel-success">
                <div class="panel-heading">
                    分组情况
                    <button class="btn btn-warning btn-xs pull-right" onclick="autoDraw()" style="margin-left:5px">自动抽签</button>
                    <button class="btn btn-info btn-xs pull-right" onclick="seedDraw()" style="margin-left:5px">种子抽签</button>
                    <button class="btn btn-danger btn-xs pull-right" onclick="clearDraw()">清空分组</button>
                </div>
                <div class="panel-body" id="groupsContainer"></div>
            </div>
            
            <button class="btn btn-primary btn-lg" onclick="generateMatches()">生成对阵表</button>
            <button class="btn btn-success btn-lg" onclick="generateSchedule()">生成赛程</button>
        </div>
    </div>
</div>

<script src="js/jquery-3.2.1.min.js"></script>
<script>
var currentEvent = null;

function loadEvents() {
    $.get('/api/admin/events', function(data) {
        var opts = '<option value="">-- 选择项目 --</option>';
        (data.events || []).forEach(function(e) {
            opts += '<option value="' + e.id + '">' + e.title + ' (' + e.groups + '组)</option>';
        });
        $('#eventSelect').html(opts);
        
        var urlEvent = new URLSearchParams(location.search).get('event');
        if (urlEvent) {
            $('#eventSelect').val(urlEvent);
            loadDraw();
        }
    });
}

function loadDraw() {
    var eventId = $('#eventSelect').val();
    if (!eventId) {
        $('#unassignedList').html('<p class="text-muted">请先选择项目</p>');
        $('#groupsContainer').html('');
        return;
    }
    
    $.get('/api/admin/draw?event=' + eventId, function(data) {
        currentEvent = data;
        
        // 待分配选手
        var unHtml = '';
        (data.unassigned || []).forEach(function(p) {
            unHtml += '<div class="player-item" onclick="assignPlayer(' + p.id + ')">' + p.name + ' <small>(' + (p.team || '无队') + ')</small></div>';
        });
        $('#unassignedList').html(unHtml || '<p class="text-muted">所有选手已分配</p>');
        $('#unassignedCount').text((data.unassigned || []).length);
        
        // 分组
        var gHtml = '<div class="row">';
        (data.groups || []).forEach(function(g, i) {
            gHtml += '<div class="col-md-6"><div class="group-box">' +
                '<div class="group-title">' + g.name + ' <small>(' + (g.players || []).length + '人)</small></div>';
            (g.players || []).forEach(function(p) {
                gHtml += '<div class="player-item">' + p.position + '. ' + p.name + 
                    ' <button class="btn btn-xs btn-danger pull-right" onclick="removePlayer(' + g.id + ',' + p.id + ')">移除</button></div>';
            });
            gHtml += '</div></div>';
        });
        gHtml += '</div>';
        $('#groupsContainer').html(gHtml);
    });
}

function assignPlayer(playerId) {
    var eventId = $('#eventSelect').val();
    var groupIndex = prompt('分配到第几组？(1-' + (currentEvent.groups || []).length + ')');
    if (!groupIndex) return;
    
    $.post('/api/admin/draw/assign', JSON.stringify({
        event_id: parseInt(eventId),
        player_id: playerId,
        group_index: parseInt(groupIndex)
    }), loadDraw, 'json');
}

function removePlayer(groupId, playerId) {
    $.post('/api/admin/draw/remove', JSON.stringify({
        group_id: groupId,
        player_id: playerId
    }), loadDraw, 'json');
}

function autoDraw() {
    var eventId = $('#eventSelect').val();
    if (!eventId) return;
    if (!confirm('自动抽签将清空现有分组，确定继续？')) return;
    
    $.post('/api/admin/draw/auto', JSON.stringify({event_id: parseInt(eventId)}), function(res) {
        if (res.success) loadDraw();
        else alert('抽签失败: ' + res.error);
    }, 'json');
}

function seedDraw() {
    var eventId = $('#eventSelect').val();
    if (!eventId) return;
    var seeds = prompt('输入种子选手ID（逗号分隔），如: 1,5,3,7\n种子将分配到不同组的1号位');
    if (!seeds) return;
    
    $.post('/api/admin/draw/seed', JSON.stringify({
        event_id: parseInt(eventId),
        seeds: seeds.split(',').map(function(s) { return parseInt(s.trim()); })
    }), function(res) {
        if (res.success) { alert('种子抽签完成'); loadDraw(); }
        else alert('抽签失败: ' + res.error);
    }, 'json');
}

function clearDraw() {
    var eventId = $('#eventSelect').val();
    if (!eventId) return;
    if (!confirm('确定清空所有分组？')) return;
    
    $.post('/api/admin/draw/clear', JSON.stringify({event_id: parseInt(eventId)}), loadDraw, 'json');
}

function generateMatches() {
    var eventId = $('#eventSelect').val();
    if (!eventId) return;
    if (!confirm('生成对阵表将覆盖现有比赛，确定继续？')) return;
    
    $.post('/api/admin/draw/matches', JSON.stringify({event_id: parseInt(eventId)}), function(res) {
        alert(res.success ? '已生成 ' + res.count + ' 场比赛' : '生成失败: ' + res.error);
    }, 'json');
}

function generateSchedule() {
    var eventId = $('#eventSelect').val();
    if (!eventId) return;
    
    var startTime = prompt('开始时间（如 09:00）', '09:00');
    if (!startTime) return;
    
    $.post('/api/admin/draw/schedule', JSON.stringify({
        event_id: parseInt(eventId),
        start_time: startTime
    }), function(res) {
        alert(res.success ? '赛程已生成' : '生成失败: ' + res.error);
    }, 'json');
}

loadEvents();
</script>
</body>
</html>
