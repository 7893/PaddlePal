<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>项目管理 - 赛事助手</title>
    <link rel="stylesheet" href="templets/metro/css/bootstrap.min.css">
    <style>
        .admin-nav { background: #337ab7; padding: 10px 20px; margin-bottom: 20px; }
        .admin-nav a { color: white; margin-right: 20px; }
    </style>
</head>
<body>
<div class="admin-nav">
    <a href="admin.html">管理后台</a>
    <a href="tournament.html">赛事管理</a>
    <a href="events.html"><b>项目管理</b></a>
    <a href="draw.html">抽签编排</a>
    <a href="index.html">返回前台</a>
</div>

<div class="container">
    <h3>比赛项目 <button class="btn btn-primary btn-sm" onclick="showAdd()">+ 添加项目</button></h3>
    <table class="table table-striped" id="eventTable">
        <thead><tr><th>ID</th><th>项目名称</th><th>类型</th><th>小组数</th><th>局数</th><th>操作</th></tr></thead>
        <tbody></tbody>
    </table>
</div>

<div class="modal fade" id="editModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title" id="modalTitle">添加项目</h4>
            </div>
            <div class="modal-body">
                <input type="hidden" id="eventId">
                <div class="form-group">
                    <label>项目名称</label>
                    <input type="text" class="form-control" id="eventTitle" placeholder="如：男子单打">
                </div>
                <div class="form-group">
                    <label>项目类型</label>
                    <select class="form-control" id="eventType">
                        <option value="MS">男子单打</option>
                        <option value="WS">女子单打</option>
                        <option value="XS">混合单打</option>
                        <option value="MD">男子双打</option>
                        <option value="WD">女子双打</option>
                        <option value="XD">混合双打</option>
                        <option value="MT">男子团体</option>
                        <option value="WT">女子团体</option>
                        <option value="XT">混合团体</option>
                    </select>
                </div>
                <div class="form-group" id="teamFormatGroup" style="display:none">
                    <label>团体赛制</label>
                    <select class="form-control" id="teamFormat">
                        <option value="5s">五场单打</option>
                        <option value="3s">三场单打</option>
                        <option value="2s1d">两单一双</option>
                        <option value="4s1d">四单一双</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>赛制</label>
                    <select class="form-control" id="eventStage">
                        <option value="loop">循环赛</option>
                        <option value="knockout">淘汰赛</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>小组数（循环赛）/ 参赛人数（淘汰赛）</label>
                    <input type="number" class="form-control" id="eventGroups" value="4" min="1" max="64">
                </div>
                <div class="form-group">
                    <label>局数（几局几胜）</label>
                    <select class="form-control" id="eventBestOf">
                        <option value="3">三局两胜</option>
                        <option value="5">五局三胜</option>
                        <option value="7">七局四胜</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="saveEvent()">保存</button>
            </div>
        </div>
    </div>
</div>

<script src="js/jquery-3.2.1.min.js"></script>
<script src="templets/metro/js/bootstrap.min.js"></script>
<script>
var typeNames = {MS:'男单',WS:'女单',XS:'混单',MD:'男双',WD:'女双',XD:'混双',MT:'男团',WT:'女团',XT:'混团'};

$('#eventType').change(function() {
    var isTeam = $(this).val().endsWith('T');
    $('#teamFormatGroup').toggle(isTeam);
});

function loadEvents() {
    $.get('/api/admin/events', function(data) {
        var html = '';
        (data.events || []).forEach(function(e) {
            var stage = e.stage == 'knockout' ? '淘汰赛' : '循环赛';
            html += '<tr><td>' + e.id + '</td><td>' + e.title + '</td>' +
                '<td>' + (typeNames[e.type] || e.type) + '</td>' +
                '<td>' + stage + '/' + e.groups + '</td><td>' + e.best_of + '</td>' +
                '<td><button class="btn btn-xs btn-info" onclick="editEvent(' + e.id + ')">编辑</button> ' +
                '<button class="btn btn-xs btn-success" onclick="location.href=\'draw.html?event=' + e.id + '\'">抽签</button> ' +
                '<button class="btn btn-xs btn-danger" onclick="deleteEvent(' + e.id + ')">删除</button></td></tr>';
        });
        $('#eventTable tbody').html(html || '<tr><td colspan="6" class="text-center">暂无项目</td></tr>');
    });
}

function showAdd() {
    $('#modalTitle').text('添加项目');
    $('#eventId').val('');
    $('#eventTitle').val('');
    $('#eventType').val('MS');
    $('#eventStage').val('loop');
    $('#eventGroups').val(4);
    $('#eventBestOf').val(5);
    $('#editModal').modal('show');
}

function editEvent(id) {
    $.get('/api/admin/events?id=' + id, function(data) {
        if (data.event) {
            $('#modalTitle').text('编辑项目');
            $('#eventId').val(data.event.id);
            $('#eventTitle').val(data.event.title);
            $('#eventType').val(data.event.type);
            $('#eventStage').val(data.event.stage || 'loop');
            $('#eventGroups').val(data.event.groups);
            $('#eventBestOf').val(data.event.best_of);
            $('#editModal').modal('show');
        }
    });
}

function saveEvent() {
    var isTeam = $('#eventType').val().endsWith('T');
    $.ajax({
        url: '/api/admin/events',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            id: parseInt($('#eventId').val()) || 0,
            title: $('#eventTitle').val(),
            type: $('#eventType').val(),
            stage: $('#eventStage').val(),
            groups: parseInt($('#eventGroups').val()) || 4,
            best_of: parseInt($('#eventBestOf').val()) || 5,
            team_format: isTeam ? $('#teamFormat').val() : ''
        }),
        success: function(res) {
            if (res.success) { $('#editModal').modal('hide'); loadEvents(); }
            else alert('保存失败: ' + res.error);
        }
    });
}

function deleteEvent(id) {
    if (confirm('确定删除该项目？相关比赛数据也会被删除！')) {
        $.ajax({ url: '/api/admin/events?id=' + id, method: 'DELETE', success: loadEvents });
    }
}

loadEvents();
</script>
</body>
</html>
